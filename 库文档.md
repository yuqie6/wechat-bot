# wxauto(x) 库文档

一个强大、易用的微信自动化库，通过模拟人工操作，实现对微信客户端的自动化控制。

---

## 1. 环境与安装

### 1.1. 环境要求

| 环境 | 版本要求 |
| :--- | :--- |
| Python | 3.9 - 3.12 |
| 操作系统 | Windows 10+, Windows Server 2016+ |
| 微信客户端 | 3.9.8+ (不支持 4.0) |

### 1.2. 安装

#### 开源版

```bash
pip install wxauto
```

#### ✨ Plus 版

```bash
pip install wxautox
```

> **提示**: 你也可以为指定的 Python 版本安装：
> ```bash
> py -3.12 -m pip install wxautox
> ```

### 1.3. 激活 (仅 Plus 版)

安装 Plus 版后，需要使用激活码进行激活。

```bash
wxautox -a 你的激活码
```
或运行：
```bash
wxauto_auth
```

---

## 2. 快速上手

下面的示例将向你展示如何快速开始使用 `wxauto(x)`。

```python
# from wxauto import WeChat      # 开源版
from wxautox import WeChat   # ✨Plus版

# 1. 初始化微信实例
# 这会获取当前登录的微信对象
wx = WeChat()

# 2. 向“文件传输助手”发送消息
wx.SendMsg("你好，世界！", who="文件传输助手")

# 3. 获取当前聊天窗口的所有消息
msgs = wx.GetAllMessage()

# 4. 打印消息
print(f"成功获取到 {len(msgs)} 条消息：")
for msg in msgs:
    print('=' * 30)
    print(f"发送者: {msg.sender}\n内容: {msg.content}\n类型: {msg.type} ({msg.attr})")

print("\n✅ 操作成功！恭喜你，已经成功进行了自动化操作。")
```

---

## 3. 核心概念与设计

### 3.1. 设计理念

为确保您可以理解该文档的一些内容，这里先简单介绍一下 `wxauto(x)` 的设计思路。如下图所示，`wxauto(x)` 将微信窗口拆解为三部分，所有操作都基于对这三部分元素的识别和控制：

-   **导航栏 (NavigationBox)**：下图蓝色框内部分。
-   **会话列表 (SessionBox)**：下图绿色框内部分，由多个 `SessionElement` 组成。
-   **聊天框 (Chat)**：下图红色框内部分。

![微信窗口结构](https://raw.githubusercontent.com/cluic/wxauto/main/docs/images/wechat_window.png)

### 3.2. 核心类

`wxauto(x)` 的设计围绕几个核心类展开，理解它们是高效使用本库的关键。

#### `WeChat`
`WeChat` 类是库的主要入口，代表微信**主窗口**。它继承自 `Chat` 类，因此拥有所有聊天窗口的操作方法，并额外提供了管理全局微信状态（如获取会话列表、监听新消息等）的功能。后续文档中，`wx` 通常指代 `WeChat` 的实例。

```python
# 获取 WeChat 实例，可指定微信昵称来多开
wx = WeChat(nickname="张三") 
```

#### `Chat`
`Chat` 类代表一个独立的**聊天窗口**（可以是好友、群聊、公众号等）。当你需要对特定聊天窗口进行持续操作或监听时，会用到这个类。后续文档中，`chat` 通常指代 `Chat` 的实例。

#### `Message`
`Message` 类代表一条**消息**。它包含了消息的各种属性（如发送者、内容、类型等），并提供了与该消息交互的方法（如回复、引用、转发）。

消息主要有两个维度：
- **来源 (`attr`)**: 消息由谁发出。例如 `self` (自己)、`friend` (对方)、`system` (系统消息) 等。
- **类型 (`type`)**: 消息的内容类型。例如 `text` (文本)、`image` (图片)、`file` (文件) 等。

这两个维度可以组合，例如 `FriendTextMessage` 表示对方发来的文本消息。

```python
from wxautox.msgs import FriendMessage

# ... 获取到消息对象 msg ...
if isinstance(msg, FriendMessage):
    msg.reply("收到！") # 如果是好友消息，则自动回复
```

#### `WxParam`
一个全局配置类，用于在程序开始前调整库的默认行为，如文件保存路径、监听间隔等。

```python
from wxautox import WxParam

# 示例：将监听线程池大小设置为 8
WxParam.LISTENER_EXCUTOR_WORKERS = 8
```

#### `WxResponse`
库中许多方法的标准返回值类型，用于判断操作是否成功，并携带返回信息。

```python
# 假设 result 是一个 WxResponse 对象
result = wx.SendMsg("你好", "文件传输助手")

if result:
    print("发送成功！")
    data = result['data'] # 成功时，获取返回数据，大多数情况下为 None
else:
    print(f"发送失败: {result['message']}") # 失败时，打印错误信息
```

---

## 4. API 参考

### 4.1. `WeChat` 类 - 微信主窗口

`WeChat` 类继承了 [`Chat` 类](#42-chat-类---聊天窗口) 的所有方法。这里只列出 `WeChat` 类独有的方法。

- **初始化 `WeChat(nickname=None, debug=False)`**
  - `nickname` (str): 微信昵称，用于在多开场景下定位特定的微信窗口。
  - `debug` (bool): 是否开启调试模式。

- **`GetSession()`**
  - 获取当前会话列表。
  - **返回**: `List[SessionElement]` - 当前会话列表的元素集合。

- **`ChatWith(who, exact=False)`**
  - 搜索并打开指定对象的聊天窗口。
  - `who` (str): 聊天对象名称（好友、群聊等）。
  - `exact` (bool): 是否精确匹配名称。

- **`GetSubWindow(nickname)`**
  - 获取一个已独立出来的子窗口实例。
  - `nickname` (str): 子窗口的昵称。
  - **返回**: `Chat` - 子窗口实例。

- **`GetAllSubWindow()`**
  - 获取所有已打开的子窗口实例。
  - **返回**: `List[Chat]`

- **`AddListenChat(nickname, callback)`**
  - 添加一个聊天监听。
  - `nickname` (str): 要监听的聊天对象。
  - `callback` (Callable): 收到消息后的回调函数，函数签名为 `def on_message(msg: Message, chat: Chat):`。
  - **返回**: `Chat` (成功) 或 `WxResponse` (失败)。

- **`RemoveListenChat(nickname)`**
  - 移除一个聊天监听。
  - `nickname` (str): 要移除监听的聊天对象。

- **`StartListening()`**
  - 开始监听所有已添加的聊天。这是一个非阻塞方法。

- **`StopListening(remove=True)`**
  - 停止所有监听。
  - `remove` (bool): 是否关闭所有监听的子窗口。

- **`KeepRunning()`**
  - 阻塞主线程，保持程序运行。通常在只使用监听功能时调用。

- **`GetNextNewMessage(filter_mute=False)`**
  - 获取下一个新消息。
  - `filter_mute` (bool): 是否过滤掉免打扰消息。
  - **返回**: `Dict` - 包含新消息的字典。

- **✨ `GetFriendDetails(n=None, tag=None, timeout=0xFFFFF)`**
  - 获取好友列表详情。**注意：此方法速度较慢，请谨慎使用。**
  - `n` (int): 获取前 n 个好友。
  - `tag` (str): 从指定拼音首字母开始。
  - **返回**: `List[dict]` - 好友详情列表。

- **✨ `GetNewFriends(acceptable=True)`**
  - 获取新的好友申请列表。
  - `acceptable` (bool): 是否只返回可接受的申请。
  - **返回**: `List[NewFriendElement]`

- **✨ `AddNewFriend(keywords, ...)`**
  - 通过搜索添加新好友。
  - `keywords` (str): 搜索关键词（昵称、微信号、手机号等）。
  - `addmsg` (str): 申请理由。
  - `remark` (str): 备注名。

- **✨ `Moments(timeout=3)`**
  - 进入朋友圈。
  - **返回**: `MomentsWnd` - 朋友圈窗口实例。

- **`SwitchToChat()` / `SwitchToContact()`**
  - 切换到微信主窗口的“聊天”或“通讯录”页面。

- **✨ `IsOnline()`**
  - 检查微信是否在线。
  - **返回**: `bool`

- **✨ `GetMyInfo()`**
  - 获取自己的微信号等信息。
  - **返回**: `Dict[str, str]`

### 4.2. `Chat` 类 - 聊天窗口

代表一个独立的聊天窗口（好友、群聊、公众号等）。

#### 属性
- `chat_type` (str): 聊天类型，返回 `friend`, `group`, `service`, `official`。

#### 方法
- **`Show()`**: 显示（激活）该聊天窗口。
- **`Close()`**: 关闭该聊天窗口。
- **`ChatInfo()`**: 获取聊天窗口信息。
  - **返回**: `dict` - 包含 `chat_type`, `chat_name`, `group_member_count` (如果是群聊) 等信息。
- **`SendMsg(msg, who=None, clear=True, at=None, exact=False)`**: 发送消息。
  - `msg` (str): 消息内容。
  - `who` (str): 发送对象，**当 `Chat` 实例调用时，此参数无效**。
  - `clear` (bool): 发送后是否清空输入框。
  - `at` (Union[str, List[str]]): 需要 @ 的对象。
  - `exact` (bool): 搜索 `who` 时是否精确匹配，**当 `Chat` 实例调用时，此参数无效**。
- **✨ `SendTypingText(msg, who=None, clear=True, exact=False)`**: 以打字机模式发送文本消息，支持换行和 `@`。
  - **示例**: `wx.SendTypingText('各位好\n{@张三} 负责前端', who='工作群')`
- **`SendFiles(filepath, who=None, exact=False)`**: 发送文件或图片。
  - `filepath` (Union[str, List[str]]): 文件的绝对路径。
- **✨ `SendEmotion(emotion_index, who=None, exact=False)`**: 发送自定义表情。
  - `emotion_index` (int): 表情索引，从 0 开始。
- **`GetAllMessage()`**: 获取当前聊天窗口中所有已加载的消息。
  - **返回**: `List[Message]`
- **`LoadMoreMessage()`**: 向上滚动加载更多历史消息。
- **✨ `AtAll(msg, who)`**: 在群聊中 `@所有人`。
  - `msg` (str): 要发送的消息。
  - `who` (str): 群聊名称。
- **✨ `AddGroupMembers(group, members, reason=None)`**: 添加群成员。
- **✨ `GetGroupMembers()`**: 获取当前群聊的成员列表。
  - **返回**: `List[str]`
- **✨ `RemoveGroupMembers(group, members)`**: 从群聊中移除成员。
- **✨ `AddFriendFromGroup(index, ...)`**: 从群聊成员列表中添加好友。
- **✨ `ManageFriend(remark=None, tags=None)`**: 修改当前好友的备注或标签。
- **✨ `ManageGroup(name=None, notice=None, ...)`**: 管理当前群聊信息，如修改群名、群公告、退群等。

### 4.3. `Message` 类 - 消息

代表一条聊天消息。所有具体的消息类型都继承自此类。

#### 通用属性
- `type` (str): 消息内容类型 (`text`, `image`, `file` ...)。
- `attr` (str): 消息来源类型 (`self`, `friend`, `system` ...)。
- `sender` (str): 发送者昵称。
- `content` (str): 消息的文本内容。
- `id` (str): 消息的UI ID，每次UI刷新会变。
- ✨ `hash` (str): 消息的哈希值，UI刷新后不变，可用于持久化识别。

#### 通用方法
- `chat_info()`: 获取该消息所属的聊天窗口信息。
- `roll_into_view()`: 将该消息滚动到屏幕可见区域。
- `click()`: 点击消息（对图片、视频、文件等有效）。
- `select_option(option)`: 右键点击消息并选择菜单项（如“复制”、“转发”）。
- `quote(text, at=None)`: 引用并回复该消息。
- `forward(targets)`: 转发该消息。
- ✨ `tickle()`: 拍一拍该消息的发送者。
- ✨ `delete()`: 删除该消息。
- ✨ `download_head_image()`: 下载发送者的头像。

#### 特定消息类型
- **`TextMessage`**: 文本消息。
- **`ImageMessage`**: 图片消息。
  - `download(dir_path=None)`: 下载图片。
- **`VideoMessage`**: 视频消息。
  - `download(dir_path=None)`: 下载视频。
- **`FileMessage`**: 文件消息。
  - `download(dir_path=None)`: 下载文件。
- **`VoiceMessage`**: 语音消息。
  - `to_text()`: 将语音转换为文本。
- **`QuoteMessage`**: 引用消息。
  - `quote_content` (str): 被引用的消息内容。
- **✨ `LocationMessage`**: 位置消息。
  - `address` (str): 地址信息。
- **✨ `LinkMessage`**: 链接卡片消息。
  - `get_url()`: 获取链接地址。
- **✨ `EmotionMessage`**: 表情消息。
- **✨ `MergeMessage`**: 合并转发的消息。
  - `get_messages()`: 获取合并消息中的所有消息内容。
- **✨ `PersonalCardMessage`**: 个人名片消息。
  - `add_friend()`: 添加该名片上的联系人为好友。
- **✨ `NoteMessage`**: 笔记消息。
  - `get_content()`: 获取笔记内容（文本和文件）。
  - `to_markdown()`: 将笔记转换为 Markdown 文件。

### 4.4. `Moments` - 朋友圈

#### `MomentsWnd` - 朋友圈窗口
通过 `wx.Moments()` 获取。
- `GetMoments(next_page=False)`: 获取当前页的朋友圈内容。
- `Refresh()`: 刷新朋友圈。
- `close()`: 关闭朋友圈窗口。

#### `Moments` - 单条朋友圈
- `info` (dict): 包含发送者、内容、时间、评论、点赞等信息的字典。
- `SaveImages()`: 保存朋友圈的图片。
- `Like(like=True)`: 点赞或取消点赞。
- `Comment(text)`: 发表评论。

### 4.5. 其他重要类

#### `SessionElement` - 会话列表项
通过 `wx.GetSession()` 获取。
- **属性**: `name`, `time`, `content`, `ismute`, `isnew`, `new_count`。
- **方法**:
  - `click()`: 单击会话，切换到该聊天。
  - `double_click()`: 双击会话，将聊天窗口独立出来。
  - ✨ `delete()`: **删除会话（会删除聊天记录，请谨慎使用！）**
  - ✨ `hide()`: 隐藏会话（不在会话列表中显示）。

#### `NewFriendElement` - 新好友申请
通过 `wx.GetNewFriends()` 获取。
- **属性**: `name`, `msg` (申请信息), `acceptable`。
- **方法**:
  - `accept(remark=None, tags=None)`: 同意好友申请。
  - ✨ `delete()`: 删除该条申请。
  - ✨ `reply(text)`: 回复申请（不添加好友）。

#### ✨ `LoginWnd` - 登录窗口
用于自动登录或获取二维码。
- `LoginWnd(app_path=None)`: 初始化，可传入微信 `WeChat.exe` 的路径。
- `login()`: 自动点击登录（仅对已设置自动登录的微信有效）。
- `get_qrcode()`: 获取登录二维码图片。
- `reopen()`: 重启微信客户端。

#### ✨ `WeChatImage` - 微信图片/视频查看窗口
当通过 `msg.click()` 打开图片或视频时，会产生此类窗口。
- `ocr()`: 识别图片中的文字。
- `save(dir_path=None)`: 保存图片或视频。
- `close()`: 关闭窗口。

#### ✨ `WeChatDialog` - 微信对话框
当操作触发弹窗时（如删除操作），会产生此类对象。
- `select_option(option)`: 选择对话框中的选项，如“确定”、“取消”。
- `close()`: 关闭对话框。

---

## 5. 使用示例

### 示例 1: 监听并处理消息
```python
from wxautox import WeChat
from wxautox.msgs import FriendMessage, ImageMessage, VideoMessage
import time

wx = WeChat()

# 定义消息处理函数
def on_message(msg, chat):
    # 打印收到的每条消息
    print(f"在 [{chat.ChatInfo()['chat_name']}] 中收到来自 [{msg.sender}] 的消息: {msg.content}")

    # 示例1：自动下载图片和视频
    if isinstance(msg, (ImageMessage, VideoMessage)):
        path = msg.download()
        print(f"文件已下载到: {path}")

    # 示例2：如果是好友消息，则自动回复“收到”
    if isinstance(msg, FriendMessage):
        time.sleep(1) # 模拟思考
        msg.quote('收到')

# 添加监听“文件传输助手”，并指定回调函数
wx.AddListenChat(nickname="文件传输助手", callback=on_message)

# 开始监听（非阻塞）
wx.StartListening()

# 保持主程序运行，否则监听线程会退出
wx.KeepRunning()
```

### 示例 2: 处理好友申请
```python
from wxautox import WeChat

wx = WeChat()

# 获取新的、可以接受的好友申请
new_friends = wx.GetNewFriends(acceptable=True)
print(f"收到 {len(new_friends)} 条新的好友申请。")

# 自动处理
tags = ['自动添加', '技术群']
for friend in new_friends:
    remark = f'备注_{friend.name}'
    print(f"正在接受好友 {friend.name} 的申请...")
    friend.accept(remark=remark, tags=tags)
    print(f"已添加好友 {friend.name}，备注为 {remark}，标签为 {tags}。")
```

### 示例 3: 合并转发消息
```python
from wxautox import WeChat
from wxautox.msgs import HumanMessage

wx = WeChat()

# 1. 打开要操作的聊天窗口
wx.ChatWith("工作群")

# 2. 获取消息列表
msgs = wx.GetAllMessage()

# 3. 多选最近的 5 条消息
selected_count = 0
for msg in reversed(msgs):
    if selected_count >= 5:
        break
    if isinstance(msg, HumanMessage): # 确保是人发的消息
        msg.multi_select()
        selected_count += 1

# 4. 执行合并转发
if selected_count > 0:
    targets = ['张三', '李四']
    wx.MergeForward(targets)
    print(f"已将 {selected_count} 条消息合并转发给 {targets}")
else:
    print("没有可转发的消息。")
```

### 示例 4: 使用打字机模式发送消息
```python
from wxautox import WeChat

wx = WeChat()

# 普通文本发送
wx.SendTypingText("你好，这是一条测试消息", who="文件传输助手")

# 使用@功能和换行
wx.SendTypingText("各位好：\n{@张三} 请负责前端部分\n{@李四} 请负责后端部分", who="项目群")
```

### 示例 5: 获取多个微信客户端实例
```python
from wxautox import get_wx_clients, WeChat

# 获取所有已登录微信的 WeChat 实例
clients = get_wx_clients()
print(f"检测到 {len(clients)} 个微信客户端。")

for i, client in enumerate(clients):
    info = client.GetMyInfo()
    print(f"--- 客户端 {i+1} ---")
    print(f"  昵称: {info.get('nickname')}")
    print(f"  微信号: {info.get('wxid')}")
    # 可以对每个客户端实例进行操作
    client.SendMsg(f"我是客户端 {i+1}", who="文件传输助手")
```

### 示例 6: 获取登录二维码
```python
from wxautox import LoginWnd

# 如果微信不在默认路径，需要指定路径
# wxpath = "D:/path/to/WeChat.exe" 

# 创建登录窗口对象
loginwnd = LoginWnd() # 留空则自动查找

# 获取登录二维码图片路径
qrcode_path = loginwnd.get_qrcode()
if qrcode_path:
    print(f"二维码已保存到: {qrcode_path}")
    # 你可以在这里使用Pillow等库打开图片
    # from PIL import Image
    # Image.open(qrcode_path).show()
else:
    print("获取二维码失败。")
